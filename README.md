# Assignment 3 - S3 Bucket Size Tracking System (AWS CDK)

This project uses AWS CDK to deploy a microservices-based S3 bucket size tracking system.

## Architecture

The system is divided into 4 CloudFormation stacks:

### 1. StorageStack

- **S3 Bucket**: Stores user files and generated plots
- **DynamoDB Table**: Stores bucket size history with GSI

### 2. SizeTrackingStack

- **Lambda Function**: Triggered by S3 events (create/update/delete)
- **S3 Event Notification**: Automatic trigger configuration
- **IAM Permissions**: S3 read, DynamoDB write

### 3. PlottingStack

- **Lambda Function**: Generates matplotlib plots
- **Lambda Layer**: Contains matplotlib and dependencies
- **API Gateway**: REST API endpoint
- **IAM Permissions**: DynamoDB read, S3 write

### 4. DriverStack

- **Lambda Function**: Test orchestrator
- **IAM Permissions**: S3 read/write/delete

## Prerequisites

```bash
# Install AWS CDK
npm install -g aws-cdk

# Install Python dependencies
pip install -r requirements.txt

# Configure AWS credentials
export AWS_ACCESS_KEY_ID=your_key
export AWS_SECRET_ACCESS_KEY=your_secret
export AWS_DEFAULT_REGION=us-west-2
```

## Deployment

```bash
# Bootstrap CDK (first time only)
cdk bootstrap

# Synthesize CloudFormation templates
cdk synth

# Deploy all stacks
cdk deploy --all

# Or deploy individual stacks
cdk deploy S3SizeTrackingStorageStack
cdk deploy S3SizeTrackingSizeTrackingStack
cdk deploy S3SizeTrackingPlottingStack
cdk deploy S3SizeTrackingDriverStack
```

## Testing

After deployment:

```bash
# Get the outputs
aws cloudformation describe-stacks --stack-name S3SizeTrackingStorageStack
aws cloudformation describe-stacks --stack-name S3SizeTrackingPlottingStack

# Invoke the driver lambda
aws lambda invoke --function-name <driver-lambda-name> output.json

# Check the plot in S3
aws s3 ls s3://<bucket-name>/
aws s3 cp s3://<bucket-name>/plot plot.png
```

## Cleanup

```bash
# Delete all stacks (in reverse dependency order)
cdk destroy --all
```

## Key Design Decisions

1. **Multi-Stack Architecture**: Separation of concerns, easier to manage and update
2. **No Hardcoded Names**: All resource names are generated by CDK or use tokens
3. **Cross-Stack References**: Stacks share resources via CDK constructs
4. **IAM Least Privilege**: Each Lambda has only necessary permissions
5. **Environment Variables**: Lambda configuration passed via environment variables

## Stack Dependencies

```
StorageStack (base)
    ↓
    ├── SizeTrackingStack
    ├── PlottingStack
    └── DriverStack
```

## Outputs

- **BucketName**: S3 bucket name
- **TableName**: DynamoDB table name
- **ApiUrl**: Plotting API Gateway URL

## Comparison with Assignment 2

| Aspect          | Assignment 2                  | Assignment 3 (CDK)           |
| --------------- | ----------------------------- | ---------------------------- |
| Infrastructure  | Manual clicks + Python script | CDK (Infrastructure as Code) |
| Repeatability   | Manual steps required         | Fully automated              |
| Resource Names  | Hardcoded                     | Auto-generated               |
| Updates         | Error-prone                   | Safe, automated              |
| Version Control | Only Lambda code              | Entire infrastructure        |
| Rollback        | Manual                        | Automatic                    |
